###
### HTTP-Config generated with capistrano-nuxt2 at: <%= Time.now.strftime("%Y-%m-%d .. %H:%M .. %Z") %>
###


# Main SSL Server Block
server {
<% if fetch(:nginx_use_ssl) %>
  listen 443 ssl http2;
  listen [::]:443 ssl http2;

  ssl_certificate     <%= fetch(:nginx_ssl_cert) %>;
  ssl_certificate_key <%= fetch(:nginx_ssl_key) %>;

  ## Modern TLS Security
  ssl_protocols       TLSv1.2 TLSv1.3;
  ssl_ciphers         <%= fetch(:nginx_ssl_ciphers) %>;
  ssl_prefer_server_ciphers on;
  ssl_ecdh_curve      X25519:secp384r1;

  ssl_session_cache   shared:SSL:50m;
  ssl_session_tickets off;

  ## OCSP Stapling for Faster SSL Handshakes
  ssl_stapling        on;
  ssl_stapling_verify on;
  resolver            8.8.8.8 8.8.4.4 valid=300s;
  resolver_timeout    5s;

  ## Security Headers
  add_header X-Frame-Options DENY;
  add_header X-Content-Type-Options nosniff;
  add_header Referrer-Policy "strict-origin-when-cross-origin";

  ## Enable HTTP Strict Transport Security (HSTS)
  <% if fetch(:nginx_strict_security) %>
  add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload";
  <% end %>

  ## Remove "www" from URLs
  <% if fetch(:nginx_remove_www) %>
  if ($host ~* ^www\.(?<domain>.*)) {
    return 301 <%= fetch(:nginx_use_ssl) ? "https" : "http" %>://$domain$request_uri;
  }
  <% end %>

<% else %>
  listen 80;
  listen [::]:80;
<% end %>

  <% if fetch(:nginx_major_domain) %>
  server_name <%= fetch(:nginx_domain_wildcard, false) ? "." : "" %><%= fetch(:nginx_major_domain).gsub(/^\*?\./, "") %>;
  <% else %>
  server_name <%= nginx_domains_with_www.join(joiner) %>;
  <% end %>


  access_log <%= fetch(:nginx_log_path) %>/nginx-access.log;
  error_log  <%= fetch(:nginx_log_path) %>/nginx-error.log;

  error_page 404 /404.html;
  location /404.html { root <%= fetch(:deploy_to) %>/current/<%= fetch(:nginx_static_dir) %>; }

  error_page 500 502 503 504 /500.html;
  location /500.html { root <%= fetch(:deploy_to) %>/current/<%= fetch(:nginx_static_dir) %>; }

  client_max_body_size  4G;
  keepalive_timeout     10;

  gzip                on;
  gzip_types          text/plain application/xml text/css application/javascript;
  gzip_min_length     1000;


  location ^~ /assets/ {
    gzip_static on;
    expires max;
    add_header Cache-Control public;
  }

<% if fetch(:allow_well_known) %>
  location ~ /.well-known {
    allow all;
    root <%= shared_path %>;
  }
<% end %>


  # Static Files

  # root                  <%= shared_path %>/dist;
  root                  <%= shared_path %>/www;

  # index
  # index index.html;

  # SPA-routing
  location / {
    try_files $uri $uri/ /404.html;
  }
}
